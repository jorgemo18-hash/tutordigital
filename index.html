<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ttutordigital</title>

  <style>
    :root{
      --bg:#fafafa;
      --card:#fff;
      --text:#111;
      --muted:#666;
      --line:#eaeaea;
      --shadow:0 12px 30px rgba(0,0,0,.08);
      --shadow2:0 18px 50px rgba(0,0,0,.10);
      --radius:16px;
    }

    /* ---------- BASE ---------- */
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
      background:var(--bg);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      padding:18px;
    }

    .card{
      background:var(--card);
      padding:24px;
      border-radius:16px;
      max-width:520px;
      width:min(520px, 92vw);
      box-shadow:var(--shadow);
      border:1px solid var(--line);
    }

    .tag{
      display:inline-block;
      font-size:13px;
      padding:6px 10px;
      border-radius:999px;
      background:#eee;
      margin-bottom:12px;
      font-weight:800;
    }

    h1{
      margin:0 0 10px;
      font-size:28px;
      letter-spacing:-.2px;
    }

    p{
      margin:0 0 10px;
      line-height:1.5;
      color:#333;
    }

    .note{
      margin-top:10px;
      font-size:13px;
      color:var(--muted);
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:14px;
    }

    button.btn{
      display:inline-block;
      font-weight:900;
      border-radius:12px;
      padding:10px 14px;
      border:1px solid #111;
      cursor:pointer;
      background:#111;
      color:#fff;
      font-size:15px;
    }
    button.btn:active{ transform:translateY(1px); }

    /* ---------- MODAL CHAT ---------- */
    .modalOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:1000;
      opacity:0;
      pointer-events:none;
      transition:opacity .25s ease;
    }

    .modalOverlay.open{
      opacity:1;
      pointer-events:auto;
    }

    .modal{
      width:min(900px, 96vw);
      height:min(720px, 90vh);
      background:#fff;
      border-radius:18px;
      overflow:hidden;
      box-shadow:0 20px 60px rgba(0,0,0,.25);
      display:flex;
      flex-direction:column;
      transform:translateY(20px) scale(.96);
      transition:transform .25s ease;
      border:1px solid rgba(255,255,255,.15);
    }

    .modalOverlay.open .modal{
      transform:translateY(0) scale(1);
    }

    .modalTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid #eee;
      font-weight:900;
      background:#fff;
      flex:0 0 auto;
    }

    .modalTop button{
      border:0;
      background:#f2f2f2;
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      font-weight:800;
    }

    /* nuevo contenedor body: iframe + pad */
    .modalBody{
      flex:1;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      background:#fff;
    }

    #chatFrame{
      flex:1;
      width:100%;
      border:0;
      background:#fff;
    }

    /* ---------- Teclado cientÃ­fico en el PADRE ---------- */
    #padOutside{
      display:none;
      border-top:1px solid var(--line);
      background:#fff;
      padding:10px 12px;
      flex:0 0 auto;
    }
    #padOutside.show{ display:block; }

    #padOutside .padRow{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }

    #padOutside button{
      border:1px solid #ddd;
      background:#fff;
      border-radius:10px;
      padding:7px 10px;
      font-weight:900;
      cursor:pointer;
      font-size:13px;
      line-height:1;
    }
    #padOutside button:active{ transform:translateY(1px); }

    /* ---------- MINI BAR ---------- */
    .miniBar{
      position:fixed;
      right:18px;
      bottom:18px;
      display:none;
      align-items:center;
      gap:10px;
      background:#111;
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      box-shadow:0 12px 30px rgba(0,0,0,.25);
      z-index:1100;
    }

    .miniBar .label{
      font-weight:900;
      font-size:14px;
      white-space:nowrap;
    }

    .miniBar button{
      border:0;
      border-radius:10px;
      cursor:pointer;
      font-weight:900;
      padding:6px 10px;
    }

    .miniBar .openBtn{
      background:#fff;
      color:#111;
    }

    .miniBar .closeMini{
      background:rgba(255,255,255,.2);
      color:#fff;
    }

    .miniBar input{
      width:240px;
      max-width:40vw;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.12);
      color:#fff;
      outline:none;
      font-size:16px;
    }

    .miniBar input::placeholder{
      color:rgba(255,255,255,.75);
    }
  </style>
</head>

<body>

  <!-- PORTADA -->
  <div class="card">
    <div class="tag">Ttutordigital</div>
    <h1>Tutor digital para alumnos</h1>
    <p>OrganizaciÃ³n diaria, prioridades claras y acompaÃ±amiento para ponerse a estudiar.</p>
    <p class="note">Demo funcional. Validando experiencia.</p>

    <div class="row">
      <button class="btn" id="openChat" type="button">Entrar a la app</button>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modalOverlay" id="overlay" aria-hidden="true">
    <div class="modal">

      <!-- HEADER DEL MODAL -->
      <div class="modalTop">
        <div>Ttutordigital Â· Chat</div>
        <div>
          <button id="minimizeChat" type="button">Minimizar</button>
          <button id="closeChat" type="button">Cerrar</button>
        </div>
      </div>

      <!-- BODY (iframe + teclado) -->
      <div class="modalBody">
        <iframe id="chatFrame" src="./app.html" title="Chat"></iframe>

        <!-- Teclado cientÃ­fico (PADRE) -->
        <div id="padOutside" aria-hidden="true">
          <div class="padRow">
            <button type="button" data-i="()"> ( ) </button>
            <button type="button" data-i="[]"> [ ] </button>
            <button type="button" data-i="+"> + </button>
            <button type="button" data-i="âˆ’"> âˆ’ </button>
            <button type="button" data-i="Ã—"> Ã— </button>
            <button type="button" data-i="Ã·"> Ã· </button>
            <button type="button" data-i="x^2"> xÂ² </button>
            <button type="button" data-i="x^3"> xÂ³ </button>

            <button type="button" data-i="^{}"> x^ </button>
            <button type="button" data-i="âˆš()"> âˆš </button>
            <button type="button" data-i="Ï€"> Ï€ </button>

            <button type="button" data-i="sin()"> sin </button>
            <button type="button" data-i="cos()"> cos </button>
            <button type="button" data-i="tan()"> tan </button>
            <button type="button" data-i="log()"> log </button>
            <button type="button" data-i="ln()"> ln </button>

            <button type="button" data-i="/"> a/b </button>
            <button type="button" data-i="â‰¤"> â‰¤ </button>
            <button type="button" data-i="â‰¥"> â‰¥ </button>
            <button type="button" data-i="âˆž"> âˆž </button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- MINI BAR -->
  <div class="miniBar" id="miniBar" aria-hidden="true">
    <div class="label">Ttutordigital Â· Chat</div>
    <input id="miniInput" type="text" placeholder="Escribeâ€¦" />
    <button class="openBtn" id="miniSend" type="button">Enviar</button>
    <button class="closeMini" id="miniClose" type="button">Ã—</button>
  </div>

  <script>
    const isMobile = window.matchMedia("(max-width: 768px)").matches;

    const openBtn     = document.getElementById("openChat");
    const overlay     = document.getElementById("overlay");
    const frame       = document.getElementById("chatFrame");

    const minimizeBtn = document.getElementById("minimizeChat");
    const closeBtn    = document.getElementById("closeChat");

    const miniBar     = document.getElementById("miniBar");
    const miniClose   = document.getElementById("miniClose");

    const miniInput   = document.getElementById("miniInput");
    const miniSend    = document.getElementById("miniSend");

    const padOutside  = document.getElementById("padOutside");

    const STORAGE_KEY = "ttutordigital_chat_state";
    // valores: "open" | "minimized" | "closed"

    function setState(v){
      try { localStorage.setItem(STORAGE_KEY, v); } catch(e){}
    }
    function getState(){
      try { return localStorage.getItem(STORAGE_KEY) || "closed"; }
      catch(e){ return "closed"; }
    }

    function focusChatInput(){
      if(frame && frame.contentWindow){
        frame.contentWindow.postMessage("focusInput", "*");
      }
    }

    function openChat(){
      if(isMobile){
        window.location.href = "./app.html";
        return;
      }
      overlay.classList.add("open");
      overlay.setAttribute("aria-hidden","false");

      if(miniBar){
        miniBar.style.display = "none";
        miniBar.setAttribute("aria-hidden","true");
      }

      setState("open");
      focusChatInput();
    }

    function minimizeChat(){
      overlay.classList.remove("open");
      overlay.setAttribute("aria-hidden","true");

      // al minimizar, tambiÃ©n cerramos el pad
      if(padOutside) padOutside.classList.remove("show");

      if(!isMobile && miniBar){
        miniBar.style.display = "flex";
        miniBar.setAttribute("aria-hidden","false");
      }
      setState("minimized");
    }

    function closeChat(){
      overlay.classList.remove("open");
      overlay.setAttribute("aria-hidden","true");

      if(padOutside) padOutside.classList.remove("show");

      if(miniBar){
        miniBar.style.display = "none";
        miniBar.setAttribute("aria-hidden","true");
      }
      setState("closed");
    }

    function sendMiniText(){
      const text = (miniInput?.value || "").trim();
      if(!text) return;

      openChat();

      if(frame && frame.contentWindow){
        frame.contentWindow.postMessage({ type: "sendText", text }, "*");
      }

      if(miniInput) miniInput.value = "";
    }

    /* ---------- EVENTOS (SAFE) ---------- */
    openBtn && openBtn.addEventListener("click", openChat);
    minimizeBtn && minimizeBtn.addEventListener("click", minimizeChat);
    closeBtn && closeBtn.addEventListener("click", closeChat);

    miniClose && miniClose.addEventListener("click", closeChat);

    miniSend && miniSend.addEventListener("click", sendMiniText);
    miniInput && miniInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter") sendMiniText();
    });

    overlay && overlay.addEventListener("click", (e) => {
      if(e.target === overlay) minimizeChat();
    });

    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape") minimizeChat();
    });

    /* ---------- MENSAJES DESDE EL IFRAME ---------- */
    window.addEventListener("message", (event) => {
      if (!event.data) return;

      // El iframe pide abrir/cerrar el teclado externo
      if (event.data.type === "togglePad") {
        if (!padOutside) return;
        padOutside.classList.toggle("show");
        return;
      }
    });

    /* ---------- CLICK EN TECLADO EXTERNO ---------- */
  padOutside && padOutside.addEventListener("click", (e) => {
  const b = e.target.closest("button[data-i]");
  if (!b) return;

  let value = b.dataset.i;

  // operadores â€œbonitosâ€ â†’ Ãºtiles
  if (value === "Ã—") value = "*";
  if (value === "Ã·") value = "/";
  if (value === "âˆ’") value = "-";

  // ðŸŒ± RAÃZ: âˆš() con cursor dentro
  if (value === "âˆš()" || value === "âˆš") {
    frame.contentWindow.postMessage(
      { type: "insert", value: "âˆš()" },
      "*"
    );
    frame.contentWindow.postMessage(
      { type: "moveCursor", offset: -1 },
      "*"
    );
    return;
  }

  // âž— FRACCIÃ“N: ()/() con cursor en el numerador
  if (value === "/") {
    frame.contentWindow.postMessage(
      { type: "insert", value: "()/()" },
      "*"
    );
    frame.contentWindow.postMessage(
      { type: "moveCursor", offset: -4 },
      "*"
    );
    return;
  }

  // ðŸ‘‰ resto de botones: inserciÃ³n normal
  if (frame && frame.contentWindow) {
    frame.contentWindow.postMessage(
      { type: "insert", value },
      "*"
    );
  }
});

  if(frame && frame.contentWindow){
    frame.contentWindow.postMessage({ type:"insert", value }, "*");
  }
});
    /* ---------- RESTAURAR ESTADO (SIN AUTOABRIR) ---------- */
    window.addEventListener("load", () => {
      if(isMobile) return;

      const state = getState();

      if(state === "minimized"){
        overlay.classList.remove("open");
        overlay.setAttribute("aria-hidden","true");
        if(miniBar){
          miniBar.style.display = "flex";
          miniBar.setAttribute("aria-hidden","false");
        }
      } else {
        closeChat();
      }
    });
  </script>

</body>
</html>
