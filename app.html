<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<style>
  body{
    margin:0;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
    background:#fff;
    color:#111;
    height:100dvh;              /* clave en m√≥vil */
    display:flex;
    flex-direction:column;
  }

  header{
    display:flex;gap:12px;align-items:center;
    padding:14px;border-bottom:1px solid #eee;background:#fff;
    position:sticky;top:0;z-index:10;
  }

  main{
    flex:1;
    overflow:auto;
    background:#fafafa;
    padding:14px;
    padding-bottom:110px;       /* deja hueco para la barra fija */
  }

  footer{
    position:fixed;
    left:0; right:0; bottom:0;
    display:flex; gap:8px;
    padding:12px;
    padding-bottom:calc(12px + env(safe-area-inset-bottom));
    border-top:1px solid #eee;
    background:#fff;
    z-index:20;
  }

  input{
    flex:1;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid #ddd;
    outline:none;

    font-size:16px;             /* <- evita el zoom de iOS */
    line-height:1.2;
    -webkit-text-size-adjust:100%;
  }

  button{
    padding:10px 14px;border-radius:10px;
    border:1px solid #111;background:#111;color:#fff;font-weight:800;
  }
  button:disabled{opacity:.5}
</style>
</head>
<body>

<header>
  <a class="back" href="./index.html">‚Üê Inicio</a>
  <div>
    <div class="title">Ttutordigital</div>
    <div class="sub">Modo alumno ¬∑ Demo</div>
  </div>
</header>

<main id="chat">
  <!-- Agenda fija arriba -->
  <div class="agenda" id="agenda"></div>

  <!-- Conversaci√≥n -->
  <div id="msgs"></div>
</main>

<footer>
  <input id="inp" placeholder="Escribe aqu√≠‚Ä¶" />
  <button id="btn" disabled>Enviar</button>
</footer>

<script>
  const chatScroll = document.getElementById("chat");
  const agenda = document.getElementById("agenda");
  const msgs = document.getElementById("msgs");
  const inp = document.getElementById("inp");
  const btn = document.getElementById("btn");

  // --------- DATOS DEMO ---------
  const demoData = {
    homework: [
      "Lengua ¬∑ Ejercicios 3 y 4",
      "Tecnolog√≠a ¬∑ Ejercicios 1 y 2",
      "Matem√°ticas ¬∑ Problema 5"
    ],
    exam: "Matem√°ticas ¬∑ viernes",
    project: "Historia ¬∑ entrega en 15 d√≠as"
  };

  // --------- STORAGE / REINICIO DIARIO (modo 2) ---------
  const DAY_KEY = "ttd_chat_day";
  const CHAT_KEY = "ttd_chat_log";

  function todayStr(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }

  function loadLog(){
    try{
      return JSON.parse(localStorage.getItem(CHAT_KEY) || "[]");
    }catch(e){
      return [];
    }
  }

  function saveLog(log){
    localStorage.setItem(CHAT_KEY, JSON.stringify(log));
  }

  function resetChat(){
    msgs.innerHTML = "";
    const init = [
      { role:"assistant", text:"Esta es tu agenda de hoy. Elige por d√≥nde quieres empezar y lo vemos juntos." }
    ];
    saveLog(init);
    renderLog(init);
  }

  function ensureToday(){
    const saved = localStorage.getItem(DAY_KEY);
    const t = todayStr();
    if(saved !== t){
      localStorage.setItem(DAY_KEY, t);
      resetChat();
    }
  }

  // --------- RENDER AGENDA ---------
  function renderAgenda(){
    agenda.innerHTML = `
      <div class="agendaTitle">Agenda de hoy</div>

      <div class="block agendaBtn" data-action="DEBERES">
        <div class="blockTitle">üìò Deberes de ma√±ana</div>
        <ul class="alist">
          ${demoData.homework.map(x => `<li>${x}</li>`).join("")}
        </ul>
      </div>

      <div class="block agendaBtn" data-action="EXAMEN">
        <div class="blockTitle">üìù Pr√≥ximo examen</div>
        <div class="blockText">${demoData.exam}</div>
      </div>

      <div class="block agendaBtn" data-action="TRABAJO">
        <div class="blockTitle">üìÇ Trabajo</div>
        <div class="blockText">${demoData.project}</div>
      </div>

      <div class="hint">
        üí° Mi sugerencia: empieza por los deberes de ma√±ana. Suele ayudar quitarse primero lo que requiere m√°s atenci√≥n.
      </div>
    `;

    document.querySelectorAll(".agendaBtn").forEach(el => {
      el.addEventListener("click", () => {
        sendText(el.dataset.action);
      });
    });
  }

  // --------- CHAT UI ---------
  function addBubble(role, text){
    const row = document.createElement("div");
    row.className = "row " + (role === "user" ? "u" : "a");
    const bub = document.createElement("div");
    bub.className = "bubble";
    bub.textContent = text;
    row.appendChild(bub);
    msgs.appendChild(row);
  }

  function renderLog(log){
    msgs.innerHTML = "";
    log.forEach(m => addBubble(m.role, m.text));
    scrollToBottom();
  }

  function scrollToBottom(){
    chatScroll.scrollTop = chatScroll.scrollHeight;
  }

  // --------- RESPUESTAS DEMO ---------
  function demoAnswer(t){
    const raw = String(t || "").trim();
    const low = raw.toLowerCase();

    // Acciones de agenda
    if(raw === "DEBERES" || low.includes("deberes")){
      return `Perfecto. Vamos con los deberes para ma√±ana.\n\nDime cu√°l hacemos primero (Lengua / Tecnolog√≠a / Matem√°ticas) y te lo organizo paso a paso.`;
    }

    if(raw === "EXAMEN" || low.includes("examen")){
      return `Vale. Pr√≥ximo examen: ${demoData.exam}.\n\n¬øQuieres que hagamos un plan corto de repaso para hoy (10‚Äì15 min) o prefieres empezar por deberes primero?`;
    }

    if(raw === "TRABAJO" || low.includes("trabajo")){
      return `Genial. Trabajo pendiente: ${demoData.project}.\n\nPara no agobiar, hoy podemos hacer 1 mini-paso: elegir tema + 3 ideas clave. ¬øLo hacemos?`;
    }

    // Frase cl√°sica (por si alguien escribe ‚Äúagenda‚Äù o ‚Äúqu√© hacemos hoy‚Äù)
    if (low.includes("qu√© hacemos hoy") || low.includes("que hacemos hoy") || low.includes("agenda")){
      return `Hoy te conviene centrarte en esto:\n\n‚úÖ Deberes de ma√±ana\n- ${demoData.homework.join("\n- ")}\n\nüìå Pr√≥ximo examen\n- ${demoData.exam}\n\nüìÇ Trabajo\n- ${demoData.project}\n\n¬øEmpezamos por Deberes, Examen o Trabajo?`;
    }

    return "Vale. Si quieres, pulsa Deberes / Examen / Trabajo en la agenda de arriba, o dime qu√© necesitas y lo ajusto.";
  }

  // --------- ENVIAR TEXTO ---------
  function update(){
    btn.disabled = inp.value.trim().length === 0;
  }

  function pushToLog(role, text){
    const log = loadLog();
    log.push({role, text});
    saveLog(log);
    addBubble(role, text);
    scrollToBottom();
  }

  function sendText(text){
    ensureToday();
    const t = String(text || "").trim();
    if(!t) return;

    pushToLog("user", t);
    pushToLog("assistant", demoAnswer(t));
    setTimeout(() => inp.focus(), 0);
  }

  function sendFromInput(){
    const text = inp.value.trim();
    if(!text) return;
    inp.value = "";
    update();
    sendText(text);
  }

  // --------- MENSAJES DESDE INDEX (miniBar) ---------
  window.addEventListener("message", (event) => {
    if(event.data === "focusInput"){
      setTimeout(() => inp.focus(), 0);
      return;
    }
    if(event.data && event.data.type === "sendText"){
      sendText(event.data.text);
      return;
    }
  });

  // --------- INIT ---------
  ensureToday();
  renderAgenda();

  // Carga conversaci√≥n del d√≠a si existe
  const log = loadLog();
  if(log.length === 0){
    resetChat();
  }else{
    renderLog(log);
  }

  // Foco al abrir
  window.addEventListener("load", () => {
    setTimeout(() => inp.focus(), 0);
  });

  // Listeners input
  inp.addEventListener("input", update);
  inp.addEventListener("keydown", (e) => { if(e.key === "Enter") sendFromInput(); });
  btn.addEventListener("click", sendFromInput);
</script>

</body>
</html>
